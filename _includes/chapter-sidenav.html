{% for resource in page.source %}

{% capture chapters %}

{% for collection in site.collections %}
{% for doc in collection.docs %}
{% for source in doc.source %}
{% if source.title == resource.title and source.subject == resource.subject %}

{% if source.toc_type == "Chapter" %}
<div class="collapsible-header truncate{% if page.url contains doc.url %} active{% endif %}">
  <i class="material-icons">expand_more</i>
  {{ source.toc_type | append: '&ensp;' | append: source.toc_number | append: "&#58;&emsp;" | append: doc.title }}
</div>

{% endif %}
{% endif %}
{% endfor %}
{% endfor %}
{% endfor %}
{% endcapture %}

{% capture lessons %}

{% for collection in site.collections %}
{% for doc in collection.docs %}
{% for source in doc.source %}
{% if source.title == resource.title and source.subject == resource.subject %}

{% if source.toc_type == "Lesson" and source.chapter == resource.chapter %}
<li class="waves-effect waves-dark{% if page.url contains doc.url %} active{% endif %}">
  <a href="{{ doc.url }}">{{ source.toc_type | append: '&ensp;' | append: source.toc_number | append: "&#58;&emsp;" | append: doc.title }}</a>
</li>

{% endif %}
{% endif %}
{% endfor %}
{% endfor %}
{% endfor %}
{% endcapture %}

{% endfor %}

<ul id="navigation" class="side-nav">
  <li class="{% if page.url contains doc.url %}active{% endif %}">
    {{ chapters }}  
    <div class="collapsible-body">
      <ul>
        {{ lessons }}
      </ul>
    </div>
  </li>
</ul>